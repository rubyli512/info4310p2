<html>

<head>
    <title>INFO 4310 Project 2</title>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>
<!-- css style for gridlines -->
<style>
    body {
        background-color: rgb(228, 243, 255);
    }

    .gridlines line {
        stroke: rgb(223, 223, 223);
    }

    .gridlines .domain {
        stroke: none;
    }

    .state {
        fill: white;
    }

    .outline {
        fill: none;
        stroke: gray;
        stroke-width: 1px;
    }

    .main {
        display: flex;
        flex-direction: row;
    }

    .middle {
        display: flex;
        flex-direction: column;
    }

    .mapLegend {
        background-color: rgb(228, 243, 255);
        text-align: center;

    }

    #mapLegendNote {
        text-align: center;
        margin: 0;
        font-size: 13px;
        width: 500px;
    }

    #title {
        font-size: 80px;
        color: darkblue;
        text-align: center;
        font-weight: 600;
        margin-bottom: 0;
    }

    #intro_p {
        width: 1200px;
        margin: auto;
    }

    #year-content {
        font-family: 'Helvetica Neue, Arial';
        font-weight: 500;
        font-size: 80;
        fill: '#ccc';
        text-align: center;
        color: grey;
        margin-bottom: 0;
        margin-top: 0;
    }

    #interaction {
        width: 600px;
        margin: auto;
    }

    #slider {
        width: 600px;
        margin: auto; 
    }

    .right{
        border-style: solid;
        border-style: 1px;
        height: 350px;
    }
    #table {
        font-family: 'Helvetica Neue, Arial';
        font-weight: 70;
        font-size: 15;
        fill: '#ccc';
        text-align: left;

    }

    #table_title {
        font-family: 'Helvetica Neue, Arial';
        font-weight: 70;
        font-size: 20;
        fill: '#ccc';
        text-align: center;
    }

    .td {
        margin: 50px;
    }

    .right {
        padding-top: 100px;
    }

    .buttons {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    button {
        border-radius: 8px;
        transition-duration: 0.4s;
        font-size: 20px;
        row-gap: 10px;
        margin: 5px;

    }

    .button :hover {
        /* background-color: darkgray; */
        color: black;
    }
</style>

<body>

    <p id="title">Does Hard Work Pay Off?</p>

    <div id='big-year'>
        <p id='year-content'></p>
    </div>

    <div id="interaction">
        <input id="slider" type="range" min="2007" max="2021" value="2007" step="1" />

        <div class="buttons">
            <button id="back">Back</button>
            <button id="forward">Forward</button>
        </div>
    </div>
    <div id="intro_p">
        <p>Are hard-working people more productive and earning more than others? The below diagrams help us explore how
            the average hours worker per person relate to productivity and wage.</p>
        <p>Click on the states on the map and circles on the graph to find out more about each state.</p>
    </div>
    <script>
        function updateTitle(sl_year) {
            let big_title = d3.select("#big-year")
            big_title.select("#year-content").text(sl_year);
        }
        updateTitle(2007);
    // d3.select("#big-year").select("#year-content").text(year);
    </script>
    <div class="main">
        <div id='chloropleth'>
            <svg id="map" height="400" width="500"></svg>
            <svg id="mapLegend" height="50" width="500"></svg>
            <p id="mapLegendNote">Average Pay Per Person ($)</p>


            <script>
                const svg = d3.select("#map");
                const width_map = svg.attr("width");
                const height_map = svg.attr("height");
                const margin = {
                    top: 20,
                    right: 20,
                    bottom: 20,
                    left: 20
                };
                const mapWidth = width_map - margin.left - margin.right;
                const mapHeight = height_map - margin.top - margin.bottom;
                const map = svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
                const abbv = us_state_to_abbrev = {
                    "Alabama": "AL",
                    "Alaska": "AK",
                    "Arizona": "AZ",
                    "Arkansas": "AR",
                    "California": "CA",
                    "Colorado": "CO",
                    "Connecticut": "CT",
                    "Delaware": "DE",
                    "Florida": "FL",
                    "Georgia": "GA",
                    "Hawaii": "HI",
                    "Idaho": "ID",
                    "Illinois": "IL",
                    "Indiana": "IN",
                    "Iowa": "IA",
                    "Kansas": "KS",
                    "Kentucky": "KY",
                    "Louisiana": "LA",
                    "Maine": "ME",
                    "Maryland": "MD",
                    "Massachusetts": "MA",
                    "Michigan": "MI",
                    "Minnesota": "MN",
                    "Mississippi": "MS",
                    "Missouri": "MO",
                    "Montana": "MT",
                    "Nebraska": "NE",
                    "Nevada": "NV",
                    "New Hampshire": "NH",
                    "New Jersey": "NJ",
                    "New Mexico": "NM",
                    "New York": "NY",
                    "North Carolina": "NC",
                    "North Dakota": "ND",
                    "Ohio": "OH",
                    "Oklahoma": "OK",
                    "Oregon": "OR",
                    "Pennsylvania": "PA",
                    "Rhode Island": "RI",
                    "South Carolina": "SC",
                    "South Dakota": "SD",
                    "Tennessee": "TN",
                    "Texas": "TX",
                    "Utah": "UT",
                    "Vermont": "VT",
                    "Virginia": "VA",
                    "Washington": "WA",
                    "West Virginia": "WV",
                    "Wisconsin": "WI",
                    "Wyoming": "WY",
                    "District of Columbia": "DC",
                    "American Samoa": "AS",
                    "Guam": "GU",
                    "Northern Mariana Islands": "MP",
                    "Puerto Rico": "PR",
                    "United States Minor Outlying Islands": "UM",
                    "U.S. Virgin Islands": "VI",
                };
                const fips_codes = state_codes = {
                    'WA': '53',
                    'DE': '10',
                    'DC': '11',
                    'WI': '55',
                    'WV': '54',
                    'HI': '15',
                    'FL': '12',
                    'WY': '56',
                    'PR': '72',
                    'NJ': '34',
                    'NM': '35',
                    'TX': '48',
                    'LA': '22',
                    'NC': '37',
                    'ND': '38',
                    'NE': '31',
                    'TN': '47',
                    'NY': '36',
                    'PA': '42',
                    'AK': '02',
                    'NV': '32',
                    'NH': '33',
                    'VA': '51',
                    'CO': '08',
                    'CA': '06',
                    'AL': '01',
                    'AR': '05',
                    'VT': '50',
                    'IL': '17',
                    'GA': '13',
                    'IN': '18',
                    'IA': '19',
                    'MA': '25',
                    'AZ': '04',
                    'ID': '16',
                    'CT': '09',
                    'ME': '23',
                    'MD': '24',
                    'OK': '40',
                    'OH': '39',
                    'UT': '49',
                    'MO': '29',
                    'MN': '27',
                    'MI': '26',
                    'RI': '44',
                    'KS': '20',
                    'MT': '30',
                    'MS': '28',
                    'SC': '45',
                    'KY': '21',
                    'OR': '41',
                    'SD': '46'
                };
                const request_all_data = async function (sl_year) {
                    const us = await d3.json("us-smaller.json");
                    var states = topojson.feature(us, us.objects.states);
                    var statesMesh = topojson.mesh(us, us.objects.states);
                    var projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
                    var path = d3.geoPath().projection(projection);

                    let data = await d3.csv("processed_df.csv", d3.autoType);
                    // data = data.filter(d => d.year === parseInt(2007));

                    // const data = d3.select("processed_df.csv");
                    let compExtent = d3.extent(data, d => d.pay);
                    let compScale = d3.scaleSequential(d3.interpolateViridis).domain(compExtent);
                    let payScale = d3.scaleQuantile()
                        .domain(d3.extent(data, d => d.pay))
                        .range([d3.interpolateViridis(1), d3.interpolateViridis(0.7), d3.interpolateViridis(0.5), d3.interpolateViridis(0.3), d3.interpolateViridis(0.1)]);


                    // the below function drawLegend is written by Professor Rz from INFO 3300 Oct 3 Lecture 
                    function drawLegend(legendSelector, legendColorScale) {

                        // This code should adapt to a variety of different kinds of color scales
                        //  Credit Prof. Rz if you are basing a legend on this structure, and note PERFORMANCE CONSIDERATIONS

                        // Shrink legend bar by 5 px inwards from sides of SVG
                        const offsets = {
                            width: 10,
                            top: 2,
                            bottom: 24
                        };
                        // Number of integer 'pixel steps' to draw when showing continuous scales
                        //    Warning, not using a canvas element so lots of rect tags will be created for low stepSize, causing issues with performance -- keep this large
                        const stepSize = 4;
                        // Extend the minmax by 0% in either direction to expose more features by default
                        const minMaxExtendPercent = 0;


                        const legend = d3.select(legendSelector);
                        const legendHeight = legend.attr("height");
                        const legendBarWidth = legend.attr("width") - (offsets.width * 2);
                        const legendMinMax = d3.extent(legendColorScale.domain());
                        // recover the min and max values from most kinds of numeric scales
                        const minMaxExtension = (legendMinMax[1] - legendMinMax[0]) * minMaxExtendPercent;
                        const barHeight = legendHeight - offsets.top - offsets.bottom;

                        // In this case the "data" are pixels, and we get numbers to use in colorScale
                        // Use this to make axis labels
                        let barScale = d3.scaleLinear().domain([legendMinMax[0] - minMaxExtension,
                        legendMinMax[1] + minMaxExtension
                        ])
                            .range([0, legendBarWidth]);
                        let barAxis = d3.axisBottom(barScale);

                        // Place for bar slices to live
                        let bar = legend.append("g")
                            .attr("class", "legend colorbar")
                            .attr("transform", `translate(${offsets.width},${offsets.top})`)

                        // ****** SWITCHES FOR DIFFERENT SCALE TYPES ******

                        // Check if we're using a binning scale - if so, we make blocks of color
                        if (legendColorScale.hasOwnProperty('thresholds') || legendColorScale.hasOwnProperty('quantiles')) {
                            // Get the thresholds
                            let thresholds = [];
                            if (legendColorScale.hasOwnProperty('thresholds')) {
                                thresholds = legendColorScale.thresholds()
                            } else {
                                thresholds = legendColorScale.quantiles()
                            }

                            const barThresholds = [legendMinMax[0], ...thresholds, legendMinMax[1]];

                            // Use the quantile breakpoints plus the min and max of the scale as tick values
                            barAxis.tickValues(barThresholds);

                            // Draw rectangles between the threshold segments
                            for (let i = 0; i < barThresholds.length - 1; i++) {
                                let dataStart = barThresholds[i];
                                let dataEnd = barThresholds[i + 1];
                                let pixelStart = barAxis.scale()(dataStart);
                                let pixelEnd = barAxis.scale()(dataEnd);

                                bar.append("rect")
                                    .attr("x", pixelStart)
                                    .attr("y", 0)
                                    .attr("width", pixelEnd - pixelStart)
                                    .attr("height", barHeight)
                                    .style("fill", legendColorScale((dataStart + dataEnd) / 2.0));
                            }
                        }
                        // Else if we have a continuous / roundable scale
                        else if (legendColorScale.hasOwnProperty('rangeRound')) {


                            for (let i = 0; i < legendBarWidth; i = i + stepSize) {

                                let center = i + (stepSize / 2);
                                let dataCenter = barAxis.scale().invert(center);

                                // below normal scale bounds
                                if (dataCenter < legendMinMax[0]) {
                                    bar.append("rect")
                                        .attr("x", i)
                                        .attr("y", 0)
                                        .attr("width", stepSize)
                                        .attr("height", barHeight)
                                        .style("fill", legendColorScale(legendMinMax[0]));
                                }
                                // within normal scale bounds
                                else if (dataCenter < legendMinMax[1]) {
                                    bar.append("rect")
                                        .attr("x", i)
                                        .attr("y", 0)
                                        .attr("width", stepSize)
                                        .attr("height", barHeight)
                                        .style("fill", legendColorScale(dataCenter));
                                }
                                // above normal scale bounds
                                else {
                                    bar.append("rect")
                                        .attr("x", i)
                                        .attr("y", 0)
                                        .attr("width", stepSize)
                                        .attr("height", barHeight)
                                        .style("fill", legendColorScale(legendMinMax[1]));
                                }

                            }
                        }
                        // Otherwise we have a nominal scale
                        else {
                            let nomVals = legendColorScale.domain().sort();

                            // Use a scaleBand to make blocks of color and simple labels
                            let barScale = d3.scaleBand().domain(nomVals)
                                .range([0, legendBarWidth])
                                .padding(0.05);
                            barAxis.scale(barScale);

                            // Draw rectangles for each nominal entry
                            nomVals.forEach(d => {
                                bar.append("rect")
                                    .attr("x", barScale(d))
                                    .attr("y", 0)
                                    .attr("width", barScale.bandwidth())
                                    .attr("height", barHeight)
                                    .style("fill", legendColorScale(d));
                            });
                        }
                        // DONE w/SWITCH

                        // Finally, draw legend labels
                        legend.append("g")
                            .attr("class", "legend axis")
                            .attr("transform", `translate(${offsets.width},${offsets.top + barHeight + 5})`)
                            .call(barAxis);

                    }

                    drawLegend("#mapLegend", payScale);

                    const requestData_map = async function (sl_year) {



                        // load dataset
                        // let data = await d3.csv("processed_df.csv", d3.autoType);
                        data = data.filter(d => d.year === parseInt(sl_year));


                        let stateIdCounts = {}
                        data.forEach(row => {

                            stateIdCounts[parseInt(fips_codes[abbv[row.state]])] = row.pay;;
                        });

                        let statesPath = map.selectAll("path.state")
                            .data(states.features)
                            .join(
                                enter => enter.append("path").attr("d", path)
                                    .attr("class", "state")
                                    .style("fill", d => payScale(
                                        stateIdCounts[d.id])).call(enter => enter.transition().attr("opacity", 1)),
                                update => update.call(update => update.transition().style("fill", d => payScale(
                                    stateIdCounts[d.id]))),
                                exit => exit.call(exit => exit.transition().attr('opacity', 0).remove())
                            );
                        map.selectAll('.outline').remove();
                        map.append("path").datum(statesMesh)
                            .attr("class", "outline")
                            .attr("d", path);
                        // map.selectAll("state").style("fill", d => colorScale(d.properties.percent_artists))


                        function getKeyByValue(object, value) {
                            return Object.keys(object).find(key => object[key] === value);
                        }

                        let table = d3.select('#table');

                        map.selectAll(".state").on("click", clicked_map);
                        graph.selectAll("circle").on("click", clicked_graph);



                        function clicked_map(event, d) {
                            // Get the state code of the selected state
                            let this_state_code = event.target.__data__.id
                            this_state_code = this_state_code < 10 ? ('0' + this_state_code).toString() : this_state_code.toString();
                            let this_abbr = getKeyByValue(state_codes, this_state_code);
                            let this_state = getKeyByValue(us_state_to_abbrev, this_abbr);
                            // Remove the previous table
                            // table.selectAll('*').remove();
                            requestData_table(sl_year, "all");
                            //Check whether the same state is selected
                            if (parseInt(this_state_code) !== curr_state_selected_id) {
                                // If not so, move to a new state
                                requestData_table(sl_year, this_state);
                                // Highlight the state on the map
                                map.selectAll(".state").transition().duration(200).style("opacity", d => {
                                    if (parseInt(d.id) === parseInt(this_state_code)) {
                                        return 1;
                                    }
                                    return 0.5;
                                });
                                // Highlight the state on the graph
                                graph.selectAll("circle").transition().duration(200).style("opacity", d => {
                                    // console.log(d);
                                    if (parseInt(state_codes[us_state_to_abbrev[d.state]]) === parseInt(this_state_code)) {
                                        return 1;
                                    }
                                    return 0.5;
                                });
                                // Save the most recent selected state
                                curr_state_selected_id = parseInt(this_state_code);
                            } else {
                                // If the same state is clicked again, we de-select the state and show the overview
                                map.selectAll(".state").transition().duration(200).style("opacity", d => 1);
                                graph.selectAll("circle").transition().duration(200).style("opacity", d => 1);
                                curr_state_selected_id = "";
                                requestData_table(sl_year, "all");
                            }



                        }
                        let curr_state_selected_id = '';

                        function clicked_graph(event, d) {
                            // Similar to clicked_map
                            let this_state_code = event.target.id;
                            let this_abbr = getKeyByValue(state_codes, this_state_code);
                            let this_state = getKeyByValue(us_state_to_abbrev, this_abbr);
                            // table.selectAll('*').remove();
                            requestData_table(sl_year, "all");

                            if (parseInt(this_state_code) !== curr_state_selected_id) {
                                requestData_table(sl_year, this_state);
                                map.selectAll(".state").transition().duration(200).style("opacity", d => {
                                    if (parseInt(d.id) === parseInt(this_state_code)) {
                                        return 1;
                                    }
                                    return 0.1;
                                });
                                graph.selectAll("circle").transition().duration(200).style("opacity", d => {
                                    // console.log(d);
                                    if (parseInt(state_codes[us_state_to_abbrev[d.state]]) === parseInt(this_state_code)) {
                                        return 1;
                                    }
                                    return 0.1;
                                });
                                curr_state_selected_id = parseInt(this_state_code);

                            } else {
                                map.selectAll(".state").transition().duration(200).style("opacity", 1);
                                graph.selectAll("circle").transition().duration(200).style("opacity", 1);
                                curr_state_selected_id = '';
                                requestData_table(sl_year, "all");
                            }


                        }


                    }
                    requestData_map(sl_year);

                }
                request_all_data(2007);
            </script>
        </div>


        <div class="middle">

            <svg id="graph" width="500 " height="450" style="margin: 20px"></svg>


        </div>

        <script>
            // select and set canvas
            const graph = d3.select("svg#graph");
            // const graph = canvas.append('g').attr("id","graph_area");
            const margins = {
                top: 60,
                right: 60,
                bottom: 40,
                left: 40
            };
            const width = graph.attr("width");
            const height = graph.attr("height");
            const graphWidth = width - margins.left - margins.right;
            const graphHeight = height - margins.top - margins.bottom;
            let annotations = graph.append("g").attr("id", "annotations");
            let chartArea = graph.append("g").attr("id", "points")
                .attr("transform", `translate(${margins.left},${margins.top})`);


            d3.csv("processed_df.csv", d3.autoType).then((data) => {

                const this_data = data.filter(d => d.year === 2007)


                let outputExtent = d3.extent(this_data, d => d.output)
                let outputScale = d3.scaleLog().domain(outputExtent).range([graphHeight, 0]);
                let leftAxis = d3.axisLeft(outputScale);
                let leftGridlines = d3.axisLeft(outputScale).tickFormat('').tickSize(-graphWidth - 10);
                annotations.append("g").attr("transform", `translate(${margins.left - 10},${margins.top})`).attr("class", "axis").call(leftAxis);
                annotations.append('g').attr("transform", `translate(${margins.left - 10},${margins.top})`).attr('class', 'gridlines').call(leftGridlines);


                let bottomAxis = d3.axisBottom();
                let bottomAxisG = annotations.append('g').attr("transform", `translate(${margins.left},${margins.top + graphHeight + 10})`).attr("class", "axis");
                let employScale = d3.scaleSqrt()
                    .domain(d3.extent(this_data, d => d.employment))
                    .range([10, 30])
                let colorScale = d3.scaleOrdinal(d3.schemeCategory10);

                const hoursExtent = d3.extent(data, d => d.hours)
                const hoursScale = d3.scaleLog().domain(hoursExtent).range([0, graphWidth]);
                // console.log(hoursScale);

                bottomAxis.scale(hoursScale);
                // console.log(bottomAxis);
                bottomAxisG.transition().call(bottomAxis);

                let state_region_mapping = {
                    'Washington': 'West',
                    'Oregon': 'West',
                    'California': 'West',
                    'Nevada': 'West',
                    'Idaho': 'West',
                    'Montana': 'West',
                    'Wyoming': 'West',
                    'Utah': 'West',
                    'Colorado': 'West',
                    'Alaska': 'West',
                    'Hawaii': 'West',
                    'Maine': 'Northeast',
                    'Vermont': 'Northeast',
                    'New York': 'Northeast',
                    'New Hampshire': 'Northeast',
                    'Massachusetts': 'Northeast',
                    'Rhode Island': 'Northeast',
                    'Connecticut': 'Northeast',
                    'New Jersey': 'Northeast',
                    'Pennsylvania': 'Northeast',
                    'North Dakota': 'Midwest',
                    'South Dakota': 'Midwest',
                    'Nebraska': 'Midwest',
                    'Kansas': 'Midwest',
                    'Minnesota': 'Midwest',
                    'Iowa': 'Midwest',
                    'Missouri': 'Midwest',
                    'Wisconsin': 'Midwest',
                    'Illinois': 'Midwest',
                    'Michigan': 'Midwest',
                    'Indiana': 'Midwest',
                    'Ohio': 'Midwest',
                    'West Virginia': 'South',
                    'District of Columbia': 'South',
                    'Maryland': 'South',
                    'Virginia': 'South',
                    'Kentucky': 'South',
                    'Tennessee': 'South',
                    'North Carolina': 'South',
                    'Mississippi': 'South',
                    'Arkansas': 'South',
                    'Louisiana': 'South',
                    'Alabama': 'South',
                    'Georgia': 'South',
                    'South Carolina': 'South',
                    'Florida': 'South',
                    'Delaware': 'South',
                    'Arizona': 'Southwest',
                    'New Mexico': 'Southwest',
                    'Oklahoma': 'Southwest',
                    'Texas': 'Southwest'
                };
                let regions = ['South', 'Southwest', 'West', 'Midwest', 'Northeast'];
                let state_codes = {
                    'WA': '53',
                    'DE': '10',
                    'DC': '11',
                    'WI': '55',
                    'WV': '54',
                    'HI': '15',
                    'FL': '12',
                    'WY': '56',
                    'PR': '72',
                    'NJ': '34',
                    'NM': '35',
                    'TX': '48',
                    'LA': '22',
                    'NC': '37',
                    'ND': '38',
                    'NE': '31',
                    'TN': '47',
                    'NY': '36',
                    'PA': '42',
                    'AK': '02',
                    'NV': '32',
                    'NH': '33',
                    'VA': '51',
                    'CO': '08',
                    'CA': '06',
                    'AL': '01',
                    'AR': '05',
                    'VT': '50',
                    'IL': '17',
                    'GA': '13',
                    'IN': '18',
                    'IA': '19',
                    'MA': '25',
                    'AZ': '04',
                    'ID': '16',
                    'CT': '09',
                    'ME': '23',
                    'MD': '24',
                    'OK': '40',
                    'OH': '39',
                    'UT': '49',
                    'MO': '29',
                    'MN': '27',
                    'MI': '26',
                    'RI': '44',
                    'KS': '20',
                    'MT': '30',
                    'MS': '28',
                    'SC': '45',
                    'KY': '21',
                    'OR': '41',
                    'SD': '46'
                };

                // chartArea.selectAll("circle").data(dataInitial).join("circle")
                //     .attr("fill", d => colorScale(state_region_mapping[d.state]))
                //     .attr("cx", d => hoursScale(d.hours))
                //     .attr("cy", d => outputScale(d.output))
                //     .attr("r", d => employScale(d.employment))
                //     .attr("opacity", 0.8);

                // getData(2007);

                let text_year = d3.select("#text_year");


                function getData(sl_year) {
                    // let table = d3.select('#table');
                    sl_year = parseInt(sl_year);
                    dataInitial = data.filter(d => d.year === sl_year);
                    // console.log(dataInitial)


                    const hoursLabel = graph.append('text')
                        .attr('text-anchor', 'end')
                        .attr('class', 'year')
                        .attr('x', width - margin.right)
                        .attr('y', -100)
                        .attr('fill', 'black')
                        .attr('font-weight', 'bold')
                        .attr('font-size', '12px')
                        .text("Hours");

                    const outputLabel = graph.append('text')
                        .attr('class', 'year')
                        .attr('transform', `translate(20, ${margin.top}) rotate(-90)`)
                        .attr('text-anchor', 'end')
                        .attr('fill', '#black')
                        .attr('font-weight', 'bold')
                        .attr('font-size', '12px')
                        .text("Output");

                    graph.append('text')
                        .attr('class', 'graph_legend')
                        .attr('x', 100)
                        .attr('y', 80)
                        .attr('fill', 'red')
                        .attr('font-weight', 'bold')
                        .attr('font-size', '15px')
                        .text(" * Northeast");

                    graph.append('text')
                        .attr('class', 'graph_legend')
                        .attr('x', 100)
                        .attr('y', 100)
                        .attr('fill', 'rgb(118, 14, 187)')
                        .attr('font-weight', 'bold')
                        .attr('font-size', '15px')
                        .text(" * Midwest");

                    graph.append('text')
                        .attr('class', 'graph_legend')
                        .attr('x', 100)
                        .attr('y', 120)
                        .attr('fill', 'rgb(0, 119, 255)')
                        .attr('font-weight', 'bold')
                        .attr('font-size', '15px')
                        .text(" * South");

                    graph.append('text')
                        .attr('class', 'graph_legend')
                        .attr('x', 100)
                        .attr('y', 140)
                        .attr('fill', 'rgb(225, 131, 0)')
                        .attr('font-weight', 'bold')
                        .attr('font-size', '15px')
                        .text(" * West");

                    graph.append('text')
                        .attr('class', 'graph_legend')
                        .attr('x', 100)
                        .attr('y', 160)
                        .attr('fill', 'green')
                        .attr('font-weight', 'bold')
                        .attr('font-size', '15px')
                        .text(" * Southwest");


                    chartArea.selectAll("circle")
                        .data(dataInitial)
                        .join(
                            enter => enter.append("circle")
                                .attr("fill", d => colorScale(state_region_mapping[d.state]))
                                .attr("cx", d => hoursScale(d.hours))
                                .attr("cy", d => outputScale(d.output))
                                .attr("r", d => employScale(d.employment))
                                .attr("id", d => state_codes[us_state_to_abbrev[d.state]]


                                )
                                .attr("opacity", 0.8)
                                .call(enter => enter.transition().attr("opacity", 0.8)),
                            update => update.call(update => update.transition()
                                .attr("fill", d => colorScale(state_region_mapping[d.state]))
                                .attr("cx", d => hoursScale(d.hours))
                                .attr("cy", d => outputScale(d.output))
                                .attr("r", d => employScale(d.employment)))
                                .attr("id", d => state_codes[us_state_to_abbrev[d.state]])
                            /*
                            .attr("opacity", d => {
                                if (selecetd_state_code != -1 && state_codes[us_state_to_abbrev[d.state]] !== selected_state_code) {
                                    return 0.2;
                                } else {
                                    return 1;
                                }
                            }) */
                            ,
                            // .call( update => update.transition().duration(100)),
                            exit => exit.call(exit => exit.transition().attr('opacity', 0).remove())
                            // exit => exit
                        );
                    console.log(text_year);
                    // text_year.html("");
                    // text_year.append("text").text(sl_year).attr("x", 100).style('font-size', '100').attr('text-anchor', 'end').attr("color","red");

                    text_year.select("#year").text(sl_year);
                }
                let curr_year = 2007;
                let table = d3.select('#table');


                d3.select("#slider").on("input", function (event) {
                    let selected_year = event.target.value;
                    // console.log(selected_year);
                    // graph.selectAll('*').remove();
                    getData(selected_year);
                    // requestData_map(selected_year);
                    request_all_data(selected_year);
                    // table.selectAll('*').remove();
                    requestData_table(selected_year, "all");
                    updateTitle(selected_year);
                    curr_year = parseInt(selected_year);
                });

                d3.select("button#back").on("click", function (event) {
                    if (curr_year != 2007) {
                        curr_year -= 1;
                    }
                    d3.select('#slider').property("value", curr_year);
                    getData(curr_year);
                    request_all_data(curr_year);
                    updateTitle(curr_year);
                    // table.selectAll('*').remove();
                    requestData_table(curr_year, "all");
                });
                d3.select("button#forward").on("click", function (event) {
                    if (curr_year != 2021) {
                        curr_year += 1;
                    }
                    d3.select('#slider').property("value", curr_year);
                    getData(curr_year);
                    request_all_data(curr_year);
                    // requestData_map(curr_year);
                    updateTitle(curr_year);
                    // table.selectAll('*').remove();
                    requestData_table(curr_year, "all");
                })

                // let selected_state_code = -1;
                getData(2007);
            })
        </script>

        <div class="right">
            <div id="table_title">
                <p id="table_title_content"></p>
            </div>

            <table id="table">
                <th id="thead"></th>
                <tr>
                    <td id="payVal">
                        <p id="this_payVal">Pay</p>
                    </td>
                </tr>
                <tr>
                    <td id="hoursVal">
                        <p id="this_hoursVal"></p>
                    </td>
                </tr>
                <tr>
                    <td id="outputVal">
                        <p id="this_outputVal"></p>
                    </td>
                </tr>
                <tr>
                    <td id="employmentVal">
                        <p id="this_employmentVal"></p>
                    </td>
                </tr>
            </table>
        </div>
        <script>
            const requestData_table = async function (sl_year, states) {
                let table = d3.select('#table');
                let data = await d3.csv("processed_df.csv", d3.autoType);
                data = data.filter(d => d.year === parseInt(sl_year));
                // console.log(data);

                let table_data;
                let title;
                let pay = 0;
                let hours = 0;
                let output = 0;
                let employment = 0;
                if (states == "all") {
                    title = "U.S. Data from " + sl_year;
                    let total_length = 0;
                    for (let i = 0; i < data.length; i++) {
                        pay += data[i].pay;
                        hours += data[i].avg_hours;
                        output += data[i].output;
                        employment += data[i].employment;
                        total_length += 1;
                    }
                    pay /= total_length;
                    hours /= total_length;

                    ;
                } else {
                    title = states + " Data from " + sl_year;
                    this_state = data.filter(d => d.state === states);
                    pay = this_state[0]['pay'];
                    hours = this_state[0]['hours'];
                    output = this_state[0]['output'];
                    employment = this_state[0]['employment'];

                }



                let text_title = d3.select("#table_title");
                text_title.select("#table_title_content").text(title);

                let text_pay = d3.select("#payVal");

                text_pay.select("#this_payVal").text("Pay:     " + pay.toFixed(2).toLocaleString('en') + '   USD');
                let text_hours = d3.select("#hoursVal");

                text_hours.select("#this_hoursVal").text("Hours:     " + Math.round(hours).toLocaleString('en') + '   Hours');
                let text_output = d3.select("#outputVal");

                text_output.select("#this_outputVal").text("Average Output:     " + Math.round((output / 51)).toLocaleString('en') + '   Millions USD');
                let text_employ = d3.select("#employmentVal");

                text_employ.select("#this_employmentVal").text("Total employment:     " + Math.round(employment).toLocaleString('en') + '   Thousands of People');

            }
            requestData_table(2007, "all");
        </script>
    </div>

</body>

</html>

</html>