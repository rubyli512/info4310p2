<html>

<head>
    <title>INFO 4310 Project 2</title>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>
<!-- css style for gridlines -->
<style>
    .gridlines line {
        stroke: rgb(223, 223, 223);
    }

    .gridlines .domain {
        stroke: none;
    }

    .state {
        fill: white;
    }

    .outline {
        fill: none;
        stroke: gray;
        stroke-width: 1px;
    }
</style>
<p id="p1">
    <svg id="map" height="700" width="700"></svg>

    <script>
        const svg = d3.select("#map");
        const width_map = svg.attr("width");
        const height_map = svg.attr("height");
        const margin = { top: 20, right: 20, bottom: 20, left: 20 };
        const mapWidth = width_map - margin.left - margin.right;
        const mapHeight = height_map - margin.top - margin.bottom;
        const map = svg.append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        const requestData_map = async function () {

            const us = await d3.json("us-smaller.json");
            console.log(us);

            var states = topojson.feature(us, us.objects.states);
            var statesMesh = topojson.mesh(us, us.objects.states);
            var projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
            var path = d3.geoPath().projection(projection);
            console.log(states);
            console.log(statesMesh);

            // load dataset
            const data = d3.select("processed_df.csv");

            let compExtent = d3.extent(data, d => d.pay);
            let compScale = d3.scaleSequential(d3.interpolateViridis).domain(compExtent);

            // let statePaths = map.selectAll("path.state").data(states.features)
            //     .join("path")
            //     .attr("class", "state")
            //     .attr("note", d => d.state)
            //     .attr("d", path)
            //     .style("fill", d => compScale(d.pay))
            //     .style("stroke", "none");

            let statesPath = map.selectAll("path.state")
                .data(states.features)
                .join("path")
                .attr("d", path)
                .attr("class", "state")
                .style("fill", d => colorScale(d.properties.percent_artists)).style("stroke", "none");

            // map.selectAll("state").style("fill", d => colorScale(d.properties.percent_artists))

            map.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path);



        }
        requestData_map();


    </script>

    <svg id="graph" width="700 " height="700" style="margin: 20px"></svg>
    <input id="slider" type="range" min="2007" max="2021" step="1" />
<div class="buttons">
    <button>Back</button>
    <button>Forward</button>
</div>

<script>

    // select and set canvas
    const graph = d3.select("svg#graph");
    // const graph = canvas.append('g').attr("id","graph_area");
    const margins = { top: 40, right: 40, bottom: 40, left: 40 };
    const width = graph.attr("width");
    const height = graph.attr("height");
    const graphWidth = width - margins.left - margins.right;
    const graphHeight = height - margins.top - margins.bottom;


    d3.csv("processed_df.csv", d3.autoType).then((data) => {

        sl_year = 2007;

        // const data = await d3.csv("processed_df.csv", d3.autoType);

        console.log(data);
        // years = d3.extent(data, d => d.year)
        sl_year = parseInt(sl_year);
        dataInitial = data.filter(d => d.year === sl_year)
        console.log(dataInitial);

        // create 3 scales
        let hoursExtent = d3.extent(dataInitial, d => d.hours)
        let hoursScale = d3.scaleLog().domain(hoursExtent).range([0, graphWidth]);
        let outputExtent = d3.extent(dataInitial, d => d.output)
        let outputScale = d3.scaleLog().domain(outputExtent).range([graphHeight, 0]);
        let employScale = d3.scaleSqrt()
            .domain(d3.extent(dataInitial, d => d.employment))
            .range([5, 15])
        let colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        const hoursLabel = graph.append('text')
            .attr('text-anchor', 'end')
            .attr('class', 'year')
            .attr('x', width - margin.right)
            .attr('y', -100)
            .attr('fill', 'black')
            .attr('font-weight', 'bold')
            .attr('font-size', '12px')
            .text("Hours");

        const outputLabel = graph.append('text')
            .attr('class', 'year')
            .attr('transform', `translate(20, ${margin.top}) rotate(-90)`)
            .attr('text-anchor', 'end')
            .attr('fill', '#black')
            .attr('font-weight', 'bold')
            .attr('font-size', '12px')
            .text("Output");
        const yearLabel = graph.append('text')
            .attr('class', 'year')
            .attr('x', 40)
            .attr('y', height - margin.bottom - 600)
            .attr('fill', '#ccc')
            .attr('font-family', 'Helvetica Neue, Arial')
            .attr('font-weight', 500)
            .attr('font-size', 80)
            .text(sl_year);

        // populate the axis
        let leftAxis = d3.axisLeft(outputScale);
        let bottomAxis = d3.axisBottom(hoursScale);

        // populate gridlines
        let leftGridlines = d3.axisLeft(outputScale).tickFormat('').tickSize(-graphWidth - 10);
        let bottomGridlines = d3.axisBottom(hoursScale).tickFormat('').tickSize(-graphHeight - 10);

        // create 5 g elements    
        graph.append("g").attr("transform", `translate(${margins.left - 10},${margins.top})`).attr("class", "axis").call(leftAxis);
        graph.append('g').attr("transform", `translate(${margins.left},${margins.top + graphHeight + 10})`).attr("class", "axis").call(bottomAxis);
        graph.append('g').attr("transform", `translate(${margins.left - 10},${margins.top})`).attr('class', 'gridlines').call(leftGridlines);
        graph.append('g').attr("transform", `translate(${margins.left},${graphHeight + margins.top + 10})`).attr('class', 'gridlines').call(bottomGridlines);
        let chartArea = graph.append('g').attr("transform", `translate(${margins.left},${margins.top})`).attr("class", "chart");

        let state_region_mapping = {
            'Washington': 'West', 'Oregon': 'West', 'California': 'West', 'Nevada': 'West',
            'Idaho': 'West', 'Montana': 'West', 'Wyoming': 'West', 'Utah': 'West',
            'Colorado': 'West', 'Alaska': 'West', 'Hawaii': 'West', 'Maine': 'Northeast',
            'Vermont': 'Northeast', 'New York': 'Northeast', 'New Hampshire': 'Northeast',
            'Massachusetts': 'Northeast', 'Rhode Island': 'Northeast', 'Connecticut': 'Northeast',
            'New Jersey': 'Northeast', 'Pennsylvania': 'Northeast', 'North Dakota': 'Midwest',
            'South Dakota': 'Midwest', 'Nebraska': 'Midwest', 'Kansas': 'Midwest',
            'Minnesota': 'Midwest', 'Iowa': 'Midwest', 'Missouri': 'Midwest', 'Wisconsin': 'Midwest',
            'Illinois': 'Midwest', 'Michigan': 'Midwest', 'Indiana': 'Midwest', 'Ohio': 'Midwest',
            'West Virginia': 'South', 'District of Columbia': 'South', 'Maryland': 'South',
            'Virginia': 'South', 'Kentucky': 'South', 'Tennessee': 'South', 'North Carolina': 'South',
            'Mississippi': 'South', 'Arkansas': 'South', 'Louisiana': 'South', 'Alabama': 'South',
            'Georgia': 'South', 'South Carolina': 'South', 'Florida': 'South', 'Delaware': 'South',
            'Arizona': 'Southwest', 'New Mexico': 'Southwest', 'Oklahoma': 'Southwest',
            'Texas': 'Southwest'
        };
        let regions = ['South', 'Southwest', 'West', 'Midwest', 'Northeast'];

        chartArea.selectAll("circle").data(dataInitial).join("circle")
            .attr("fill", d => colorScale(state_region_mapping[d.state]))
            .attr("cx", d => hoursScale(d.hours))
            .attr("cy", d => outputScale(d.output))
            .attr("r", d => employScale(d.employment))
            .attr("opacity", 0.8);

        // getData(2007);

        function getData(sl_year) {
            sl_year = parseInt(sl_year);
            dataInitial = data.filter(d => d.year === sl_year);
            console.log(dataInitial)

            chartArea.selectAll("circle")
                .data(dataInitial)
                .join(
                    enter => enter.append("circle")
                        .attr("fill", d => colorScale(state_region_mapping[d.state]))
                        .attr("cx", d => hoursScale(d.hours))
                        .attr("cy", d => outputScale(d.output))
                        .attr("r", d => employScale(d.employment))
                        .attr("opacity", 0.8)
                    .call(enter => enter.transition().attr("opacity", 1))
                    ,
                    update => update.call(update => update.transition()
                        .attr("fill", d => colorScale(state_region_mapping[d.state]))
                        .attr("cx", d => hoursScale(d.hours))
                        .attr("cy", d => outputScale(d.output))
                        .attr("r", d => employScale(d.employment)))
                        .call( update => update.transition().duration(100))
                    // exit => exit
                    )
                ;
        }

        d3.select("#slider").on("input", function (event) {
            let selected_year = event.target.value;
            console.log(selected_year);
            // graph.selectAll('*').remove();
            getData(selected_year);
        });



    })

</script>

<body>

</body>

</html>